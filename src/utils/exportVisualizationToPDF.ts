import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

export interface ExportOptions {
  filename?: string;
  title?: string;
  userName?: string;
}

export const exportVisualizationToPDF = async (
  element: HTMLElement,
  options: ExportOptions = {}
): Promise<void> => {
  try {
    const {
      filename = 'visualization',
      title = 'Visualization Report',
      userName = 'User'
    } = options;

    const canvas = await html2canvas(element, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#1f2937',
      windowWidth: element.scrollWidth,
      windowHeight: element.scrollHeight
    });

    const imgWidth = 210;
    const pageHeight = 297;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    const pdf = new jsPDF({
      orientation: imgHeight > imgWidth ? 'portrait' : 'landscape',
      unit: 'mm',
      format: 'a4'
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const actualPageHeight = pdf.internal.pageSize.getHeight();

    pdf.setFillColor(31, 41, 55);
    pdf.rect(0, 0, pageWidth, actualPageHeight, 'F');

    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(18);
    pdf.text(title, pageWidth / 2, 15, { align: 'center' });

    pdf.setFontSize(10);
    pdf.setTextColor(156, 163, 175);
    const currentDate = new Date().toLocaleString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    pdf.text(`Generated: ${currentDate}`, pageWidth / 2, 22, { align: 'center' });
    pdf.text(`User: ${userName}`, pageWidth / 2, 27, { align: 'center' });

    pdf.setDrawColor(75, 85, 99);
    pdf.setLineWidth(0.5);
    pdf.line(10, 30, pageWidth - 10, 30);

    const imgData = canvas.toDataURL('image/png');

    const marginTop = 35;
    const marginBottom = 15;
    const availableHeight = actualPageHeight - marginTop - marginBottom;

    let finalImgWidth = imgWidth - 20;
    let finalImgHeight = (canvas.height * finalImgWidth) / canvas.width;

    if (finalImgHeight > availableHeight) {
      finalImgHeight = availableHeight;
      finalImgWidth = (canvas.width * finalImgHeight) / canvas.height;
    }

    const xPosition = (pageWidth - finalImgWidth) / 2;
    const yPosition = marginTop;

    pdf.addImage(imgData, 'PNG', xPosition, yPosition, finalImgWidth, finalImgHeight);

    pdf.setFontSize(8);
    pdf.setTextColor(107, 114, 128);
    pdf.text(
      'Generated by Astra Intelligence - RocketHub',
      pageWidth / 2,
      actualPageHeight - 8,
      { align: 'center' }
    );

    const sanitizedFilename = filename
      .replace(/[^a-z0-9]/gi, '-')
      .replace(/-+/g, '-')
      .toLowerCase();

    const timestamp = new Date().toISOString().split('T')[0];
    const finalFilename = `${sanitizedFilename}-${timestamp}.pdf`;

    pdf.save(finalFilename);

    return Promise.resolve();
  } catch (error) {
    console.error('Failed to export PDF:', error);
    throw new Error('Failed to generate PDF. Please try again.');
  }
};
